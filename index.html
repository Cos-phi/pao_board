<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=750">
    <link rel="icon" href="image/favicon.ico">
    <title>pao_board</title>
    <link rel="stylesheet" type="text/css" href="style.css?v=2"> <!--v=ã®å€¤ã‚’å¤‰ãˆã‚‹ã“ã¨ã§ã€CSSã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç ´æ£„ã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ã‚‚ã‚‰ã„ã¾ã™ã‚-->
</head>
<body>
    <div id="app">
        <div id="controls-top">
            <div class="top-left-buttons">
                <button id="clear" class="controls-top-button" title="ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¯ãƒªã‚¢/Clear Canvas">
                    <img class="svg-button" src="image/new.svg" style="height: 100%;" alt="Clear">
                </button>
                <button id="manual" class="controls-top-button" title="pao_boardã«ã¤ã„ã¦/About pao_board">
                    <img class="svg-button" src="image/manual.svg" style="height: 100%;" alt="Manual">
                </button>
            </div>

            <div class="top-right-buttons">
                <button id="copy-button" class="controls-top-button" title="ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼/Copy to Clipboard">
                    <img class="svg-button" src="image/copytoclipboard.svg" style="height: 100%;" alt="Copy">
                </button>
                <button id="save-button" class="controls-top-button" title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¿å­˜/Save to Download">
                    <img class="svg-button" src="image/download.svg" style="height: 100%;" alt="Download">
                </button>
                <button id="share-button" class="controls-top-button" title="å…±æœ‰/Share">
                    <img class="svg-button" src="image/share.svg" style="height: 100%;" alt="Share">
                </button>
            </div>
        </div>

        <div id="canvas-container">
            <canvas id="color-layer"></canvas>
            <canvas id="line-layer"></canvas>
            <div id="cursor"></div>
        </div>

        <div id="logo-button-container">
            <button id="open-launch-rakugaki_pao-dialog-button" class="logo-button" title="rakugaki_pao">
                <img id="rakugaki_pao-button-img" style="height: 100%;" alt="Authentication" src="image/rakugaki_pao_logo.svg">
            </button>
        </div>

        <div id="hashtag-line">
            <button id="copy-hashtag" class="copy-hashtag-button" title="ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼/Copy Hashtag">
                <span id="hashtag-text">#pao_board</span>
                <img class="icon" src="image/copytoclipboard.svg" alt="Copy hashtag">
            </button>
        </div>   
        
        <div id="message-line"></div>
        
    <div id="launch-rakugaki_pao-modal" class="modal"  style="display: none;"> <!-- none -->
        <div class="modal-content">
            <div class="dialog-title-container">
                <button id="close-post-dialog-button" class="close-dialog-button">Ã—</button>
            </div>
            <div id="preview-img-container">
                <img id="preview-img" width="360" height="360" alt="Preview Image" src="image/dummy_preview.png">
            </div>
            <div>
                <select id="sending-mode-select">
                    <option value="lines">ğŸ–Šï¸ ç·šç”»ã¨ã—ã¦è»¢é€ / Send as Line Art</option>
                    <option value="rough">ğŸ–Œï¸ ãƒ©ãƒ•ã¨ã—ã¦è»¢é€ / Send as Rough Sketch</option>
                </select>
                <br>
            <button id="launch-rakugaki_pao-button">â–¶ rakugaki_pao </button>
            
            </div>
        </div>
    </div>

    </div>

    <script>
        //HTMLè¦ç´ ã®å–å¾—
        const clearButton = document.getElementById('clear');
        const manualButton = document.getElementById('manual');
        
        const copyButton = document.getElementById('copy-button');
        const saveButton = document.getElementById('save-button');
        const shareButton = document.getElementById('share-button');

        const canvasContainer = document.getElementById('canvas-container');
        const lineLayer = document.getElementById('line-layer');
        const colorLayer = document.getElementById('color-layer');
        const cursor = document.getElementById('cursor');
        const combinedCanvas = document.createElement('canvas');
        const invertCanvas = document.createElement('canvas');

        const openLaunchRakugaki_paoDialogButton = document.getElementById('open-launch-rakugaki_pao-dialog-button');

        const hashtagLine = document.getElementById('hashtag-line');
        const messageLine = document.getElementById('message-line');
        const copyHashtagButton = document.getElementById('copy-hashtag');

        const modals = document.getElementsByClassName('modal');
        const launchRakugaki_paoModal = document.getElementById('launch-rakugaki_pao-modal');
        const closePostDialogButton = document.getElementById('close-post-dialog-button');
        const previewImg = document.getElementById("preview-img");
        const sendingModeSelect = document.getElementById('sending-mode-select');
        const launchRakugaki_paoButton = document.getElementById('launch-rakugaki_pao-button');

        //é‡è¦ãªè¨­å®š
        const rakugaki_paoBlackPenColor = "#36364A";
        const rakugaki_paoRoughColor = "#B1E6DB";

        const boardColor = rakugaki_paoBlackPenColor
        const penColor1 = "#39C2D6";
        const penColor2 = "#3BEAC0";
        const [canvasWidth,canvasHeight] = [720,720];
        const smoothingFactor = 0.375;
        const hashtag = '#pao_board';
        const toolDiameter = 2; //æç”»ãƒ„ãƒ¼ãƒ«ã®ç›´å¾„(px)


        //ã‚­ãƒ£ãƒ³ãƒã‚¹ã®åˆæœŸåŒ–
        canvasContainer.style.width = canvasWidth + 'px';
        canvasContainer.style.height = canvasHeight + 'px';
        [combinedCanvas.width, combinedCanvas.height] = [canvasWidth, canvasHeight];
        [lineLayer.width, lineLayer.height] = [canvasWidth, canvasHeight];
        [colorLayer.width, colorLayer.height] = [canvasWidth, canvasHeight];
        [invertCanvas.width, invertCanvas.height] = [canvasWidth, canvasHeight];

        const ctxLine = lineLayer.getContext('2d',{ willReadFrequently: true });
        const ctxColor = colorLayer.getContext('2d',{ willReadFrequently: true });
        const ctxCombined = combinedCanvas.getContext('2d');
        const ctxInvert = invertCanvas.getContext('2d');


        //ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
        const localstorageKeyPBLine = 'pblineLayerlskey';
        const sessionstorageKeyLastClearTime = 'pblastcleartimekey';
        const localstoragekeyRakugaki_paoLine = 'pao_board2rakugaki_paoKey';

        const rakugaki_paoImportKeyBlack = 'importblacklayer';
        const rakugaki_paoImportKeyColor = 'importcolorlayer';
        let rakugaki_paoImportParamKey = rakugaki_paoImportKeyBlack;
         
        const manualUrl = "manual.html"
        const shareUrl = "https://kurajo.ivory.ne.jp/pao_board/"
        
        //å¤‰æ•°ã®åˆæœŸåŒ–
        let outputFileName = 'pao_board.png';
        let isDrawing = false;
        let [lastX,lastY] =[0,0];
        let [beforeLastX,beforeLastY] = [0,0];

        //ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²
        clearButton.addEventListener('click', clearCanvas);
        manualButton.addEventListener('click', openManual);
        
        copyButton.addEventListener('click', copyImage);
        saveButton.addEventListener('click', saveImage);
        shareButton.addEventListener('click', shareImage);

        lineLayer.addEventListener('mousedown', startDrawingMouse);
        lineLayer.addEventListener('mousemove', drawMouse);
        lineLayer.addEventListener('mouseup', stopDrawing);
        lineLayer.addEventListener('mouseout', stopDrawingMouseOut);
        lineLayer.addEventListener('mousemove', updateCursorMouse);
        lineLayer.addEventListener('touchstart', startDrawingTouch);
        lineLayer.addEventListener('touchmove', drawTouch);
        lineLayer.addEventListener('touchend', stopDrawingTouch);
        lineLayer.addEventListener('touchcancel', stopDrawingTouch);
        lineLayer.addEventListener('touchmove', updateCursorTouch);

        openLaunchRakugaki_paoDialogButton.addEventListener('click', openLaunchRakugaki_paoDialog);
        sendingModeSelect.addEventListener('change', sendingModeSelectApplyAndGenInvertCanvas);
        launchRakugaki_paoButton.addEventListener('click', sendAndLaunchRakugaki_pao);
        closePostDialogButton.addEventListener('click',closeDialog);


        //åˆæœŸåŒ–
        restoreLocalstorage();
        if(null === window.sessionStorage.getItem(sessionstorageKeyLastClearTime)){
            setLastClearTime();
            initializeCanvasLayers();
        }
        initializeBackgroundLayer();
        initializeModal();

        //é–¢æ•°

        //æç”»ã«é–¢ã™ã‚‹é–¢æ•°
        function startDrawing(x, y) {
            isDrawing = true;
            [lastX, lastY] = [x, y];
            [beforeLastX,beforeLastY] = [x,y]
            stipple(x,y);
        }

        function draw(x, y) {
            if (!isDrawing) return;
            ctxLine.beginPath();
            ctxLine.moveTo(lastX, lastY);
            const travelSquared = (x-lastX)**2 + (y-lastY)**2;
            if(64 < travelSquared){
                const [xM,yM] = [lastX + (x - beforeLastX)/4, lastY + (y - beforeLastY)/4]; 
                ctxLine.lineTo(xM, yM); //ç§»å‹•é‡ãŒå¤šã„ã¨ãã€è£œé–“ç‚¹ã‚’ä½œã£ã¦çµŒç”±ã—ã¾ã™
                [lastX,lastY] = [xM,yM];
            }else{
                x = x*(1-smoothingFactor) + lastX*smoothingFactor;
                y = y*(1-smoothingFactor) + lastY*smoothingFactor;
            }
            ctxLine.lineTo(x, y);
            ctxLine.globalCompositeOperation = 'destination-out';
            ctxLine.lineWidth = toolDiameter;
            ctxLine.lineCap = 'round';
            ctxLine.stroke();
            
            [beforeLastX,beforeLastY] = [lastX,lastY];
            [lastX, lastY] = [x, y];
        }

        function stipple(x,y){
            ctxLine.beginPath();
            ctxLine.moveTo(x, y);
            ctxLine.globalCompositeOperation = 'destination-out';
            ctxLine.arc(x,y, toolDiameter*0.5, 0, 2*Math.PI, true);
            ctxLine.closePath();
            ctxLine.fill();
        }

        function stopDrawing() {
            isDrawing = false;
            saveLocalstorage();
        }

        function stopDrawingMouseOut(){
            stopDrawing();
            setCursorInvisible();
        }

        function updateCursor(x, y) {            
            setCursorVisible();
            cursor.style.width = `${toolDiameter}px`;
            cursor.style.height = `${toolDiameter}px`;
            cursor.style.left = `${x - toolDiameter * 0.5}px`;
            cursor.style.top = `${y - toolDiameter * 0.5}px`;
        }

        function startDrawingMouse(e) {
            startDrawing(e.offsetX, e.offsetY);
        }

        function drawMouse(e) {
            draw(e.offsetX, e.offsetY);
        }
            
        function updateCursorMouse(e) {
            updateCursor(e.offsetX, e.offsetY);
        }

        function touchToOffsetXY(e) {
            const target = e.touches[0].target;
            const r = target.getBoundingClientRect();
            return [e.touches[0].clientX - r.left, e.touches[0].clientY - r.top];
        }

        function startDrawingTouch(e) {
            e.preventDefault();
            startDrawing(...touchToOffsetXY(e));
        }

        function drawTouch(e) {
            e.preventDefault();
            draw(...touchToOffsetXY(e));
        }
        
        function stopDrawingTouch() {
            stopDrawing();
            setCursorInvisible();
        }
            
        function updateCursorTouch(e) {
            e.preventDefault();
            updateCursor(...touchToOffsetXY(e));
        }
        
        //è£½ä½œä¸­ã®çµµã®ä¿å­˜ãƒ»èª­è¾¼ã«é–¢ã™ã‚‹é–¢æ•°
        function saveLocalstorage() {
            saveLayeronlocalstorage(localstorageKeyPBLine,lineLayer);    
        }
        
        function saveLayeronlocalstorage(localstoragekey,layer){
            window.localStorage.setItem(localstoragekey,layer.toDataURL());
        }

        function restoreLocalstorage() {
            restoreLayeronlocalstorage(localstorageKeyPBLine,lineLayer);
        }

        function restoreLayeronlocalstorage(localstoragekey,layer) {
            let base64lineLayer = window.localStorage.getItem(localstoragekey);
            if ( base64lineLayer != null) {
                let image = new Image();
                image.src = base64lineLayer;
                image.onload = function(){
                    layer.getContext('2d').drawImage(image,0,0);
                }
            }
        }
        
        function initializeCanvasLayers(){
            ctxLine.globalCompositeOperation = 'source-over';
            ctxLine.fillStyle = boardColor;
            ctxLine.fillRect(0,0, canvasWidth,canvasHeight);
        }

        function initializeBackgroundLayer(){
            ctxColor.globalCompositeOperation = 'source-over';
            const gradient = ctxColor.createLinearGradient(0, 0, canvasWidth/5, canvasHeight);
            gradient.addColorStop(0, penColor1); 
            gradient.addColorStop(1, penColor2);
            ctxColor.fillStyle = gradient;
            ctxColor.fillRect(0, 0, canvasWidth, canvasHeight);
        }
        
        //ãƒªãƒ­ãƒ¼ãƒ‰ãƒ»URLã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã«é–¢ã™ã‚‹é–¢æ•°
        function reloadPage(){
            saveLocalstorage();
            location.reload()
        }


        //ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚¯ãƒªã‚¢ãƒ»çµŒéæ™‚é–“è¡¨ç¤ºã«é–¢ã™ã‚‹é–¢æ•°
        function clearCanvas() {
            initializeCanvasLayers();
            // update last clear time and persist cleared canvas in localStorage
            setLastClearTime();
            saveLocalstorage();
            showMessage('ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

        function setLastClearTime(){
            const nowTime = new Date();
            window.sessionStorage.setItem(sessionstorageKeyLastClearTime,nowTime.getTime());
        }

        function getElapsedTimeMinFromLastClearTime(){
            const lastClearTime = window.sessionStorage.getItem(sessionstorageKeyLastClearTime);
            const nowTime = new Date();
            const elapsedTimeMin = Math.trunc((nowTime.getTime() - lastClearTime)/1000/60);
            return elapsedTimeMin;
        }
        
        function showElapsedTimeFromLastClearTime(){
            const elapsedTimeMin = getElapsedTimeMinFromLastClearTime();
            showMessage(`${elapsedTimeMin} åˆ† ãŠçµµã‹ãã—ã¾ã—ãŸã€‚` );
        }

        //ãƒãƒ‹ãƒ¥ã‚¢ãƒ«è¡¨ç¤º
        function openManual(){
            location.href = manualUrl;
        }

        function setCursorVisible(){
            cursor.style.borderWidth = '2px';
        }

        function setCursorInvisible(){
            cursor.style.borderWidth = '0px';
        }



        //çµµã®ä¿å­˜ã«é–¢ã™ã‚‹é–¢æ•°
        function combineCanvas() {
            ctxCombined.drawImage(colorLayer, 0, 0);
            ctxCombined.drawImage(lineLayer, 0, 0);
        }

        function dataURLToBlob(dataURL) {
            const parts = dataURL.split(';base64,');
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;
            const uInt8Array = new Uint8Array(rawLength);
            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }
            return new Blob([uInt8Array], { type: contentType });
        }

        function setOutputFileName(){
            const nowTime = new Date();
            const timeString = nowTime.toLocaleString("ja-JP", {year: "numeric",month: "2-digit", day: "2-digit", hour:"2-digit", minute:"2-digit"}).replaceAll('/', '').replaceAll(':','').replaceAll(' ','-');
            outputFileName = timeString + '_pao_board(' + getElapsedTimeMinFromLastClearTime() +'min).png';
        }


        function copyImage() {
            combineCanvas();
            combinedCanvas.toBlob(async (blob) => {
                const item = new ClipboardItem({'image/png': blob});
                await navigator.clipboard.write([item]);
            })
            showMessage('ç”»åƒã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            showElapsedTimeFromLastClearTime();
        }

        function saveImage() {
            combineCanvas();    
            setOutputFileName();        
            const dataURL = combinedCanvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = outputFileName;
            link.href = dataURL;
            link.click();
            showElapsedTimeFromLastClearTime();
        }

        function shareImage() {
            combineCanvas();
            setOutputFileName();           
            const dataURL = combinedCanvas.toDataURL('image/png');
            const blob = dataURLToBlob(dataURL);
            const imageFile = new File([blob], outputFileName, {type: "image/png",});
            navigator.share({
                url: shareUrl,
                text: hashtag,
                title: 'pao_board',
                files: [imageFile],
            }).then(() => {
                console.log("å…±æœ‰ã—ã¾ã—ãŸã®");
            }).catch((error) => {
                console.log('å…±æœ‰ã§ãã¾ã›ã‚“ã§ã—ãŸã®â€¥â€¥');
            });
            showElapsedTimeFromLastClearTime();
        }
               
        //ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã®ã‚³ãƒ”ãƒ¼ã«é–¢ã™ã‚‹é–¢æ•°
        function copyHastag() {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(hashtag).then(function () {
                    showMessage(`ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
                }).catch(function (error) {
                    console.error('ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    alert('ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã®');
                });
            } else {
                alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã®');
            }
        }
        
        //ä¸‹éƒ¨æƒ…å ±è¡¨ç¤ºã«é–¢ã™ã‚‹é–¢æ•°
        function showMessage(text) {
            showMessage.queue = showMessage.queue || [];
            showMessage.queue.push(text);
            
            async function processQueue() {
                while (showMessage.queue.length > 0) {
                    const message = showMessage.queue.shift();
                    await new Promise((resolve) => {   
                        messageLine.style.display = 'flex';
                        hashtagLine.style.display = 'none';
                        messageLine.textContent = message; 
                        
                        setTimeout(() => {
                            messageLine.style.display = 'none';
                            hashtagLine.style.display = 'flex';
                            resolve();
                        }, 1800);
                    });
                }
            }
            if (!showMessage.isProcessing) {
                showMessage.isProcessing = true;
                processQueue().then(() => {
                    showMessage.isProcessing = false;
                });
            }
        }

        //ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚³ãƒ”ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
        copyHashtagButton.addEventListener('click', copyHastag);    

        
        //ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å…±é€š
        function closeDialog() {
            for (let i = 0; i < modals.length; i++) {
                modals[i].style.display = 'none'; 
            }
        }

        function initializeModal(){
            for (let i = 0; i < modals.length; i++) {
                //modals[i].style.display = 'none'; // å„è¦ç´ ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                modals[i].addEventListener('click', (event) => {
                    if (event.target === modals[i]) {
                        closeDialog();
                    }
                });
            }
        }

        //rakugaki_paoè»¢é€ã«é–¢é€£ã™ã‚‹é–¢æ•°
        //æŠ•ç¨¿ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        function openLaunchRakugaki_paoDialog() {
            showElapsedTimeFromLastClearTime();
            sendingModeSelectApplyAndGenInvertCanvas();
            launchRakugaki_paoModal.style.display = 'block';
        }

        function sendingModeSelectApplyAndGenInvertCanvas(){
            const selectedMode = sendingModeSelect.value;
            if(selectedMode === 'lines'){
                invertCtxLineAlphaAndChangeColor(rakugaki_paoBlackPenColor); 
                rakugaki_paoImportParamKey = rakugaki_paoImportKeyBlack;
            }else if(selectedMode === 'rough'){
                invertCtxLineAlphaAndChangeColor(rakugaki_paoRoughColor);  
                rakugaki_paoImportParamKey = rakugaki_paoImportKeyColor;
            }
            const dataURL = invertCanvas.toDataURL('image/png');
            previewImg.src = dataURL;
        }

        function invertCtxLineAlphaAndChangeColor(targetColorCode = "#FF0000"){ 
            const hex = targetColorCode.replace('#', '');
            const targetR = parseInt(hex.substring(0, 2), 16);
            const targetG = parseInt(hex.substring(2, 4), 16);
            const targetB = parseInt(hex.substring(4, 6), 16);
            // lineLayerã®ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const imageData = ctxLine.getImageData(0, 0, canvasWidth, canvasHeight);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                data[i + 0] = targetR;
                data[i + 1] = targetG;
                data[i + 2] = targetB;      
                const currentAlpha = data[i + 3];
                data[i + 3] = 255 - currentAlpha;
            }
            ctxInvert.putImageData(imageData, 0, 0);
        }

        function saveInvertCanvasLocalstorage(){
            saveLayeronlocalstorage(localstoragekeyRakugaki_paoLine,invertCanvas);    
        }

        function sendAndLaunchRakugaki_pao(){
            saveInvertCanvasLocalstorage();
            window.open('../rakugaki_pao/index.html?' + rakugaki_paoImportParamKey + '=' + localstoragekeyRakugaki_paoLine);
            closeDialog();
        }
    </script>
</body>
</html>
