<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=750">
    <link rel="icon" href="image/favicon.ico">
    <title>pao_board</title>
    <link rel="stylesheet" type="text/css" href="style.css?v=2"> <!--v=„ÅÆÂÄ§„ÇíÂ§â„Åà„Çã„Åì„Å®„Åß„ÄÅCSS„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÁ†¥Ê£Ñ„Åó„Å¶ÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„ÇÇ„Çâ„ÅÑ„Åæ„Åô„Çè-->
</head>
<body>
    <div id="app">
        <div id="controls-top">
            <div class="top-left-buttons">
                <button id="clear" class="controls-top-button">
                    <img class="svg-button" src="image/new.svg" style="height: 100%;" alt="Clear">
                </button>
            </div>

            <div class="top-right-buttons">
                <button id="copy-button" class="controls-top-button">
                    <img class="svg-button" src="image/copytoclipboard.svg" style="height: 100%;" alt="Copy">
                </button>
                <button id="save-button" class="controls-top-button">
                    <img class="svg-button" src="image/download.svg" style="height: 100%;" alt="Download">
                </button>
                <button id="share-button" class="controls-top-button">
                    <img class="svg-button" src="image/share.svg" style="height: 100%;" alt="Share">
                </button>
                <button id="manual" class="controls-top-button">
                    <img class="svg-button" src="image/manual.svg" style="height: 100%;" alt="Manual">
                </button>
            </div>
        </div>

        <div id="canvas-container">
            <canvas id="color-layer"></canvas>
            <canvas id="line-layer"></canvas>
            <div id="cursor"></div>
        </div>

        <div id="logo-button-container">
            <button id="open-launch-rakugaki_pao-dialog-button" class="logo-button" title="rakugaki_pao">
                <img id="rakugaki_pao-button-img" style="height: 100%;" alt="Authentication" src="image/rakugaki_pao_logo.svg">
            </button>
        </div>

        <div id="hashtag-line">
            <button id="copy-hashtag" class="copy-hashtag-button">
                <span id="hashtag-text">#pao_board</span>
                <img class="icon" src="image/copytoclipboard.svg" alt="Copy hashtag">
            </button>
        </div>   
        
        <div id="message-line"></div>
        
    <div id="launch-rakugaki_pao-modal" class="modal"  style="display: none;"> <!-- none -->
        <div class="modal-content">
            <div class="dialog-title-container">
                <button id="close-post-dialog-button" class="close-dialog-button">√ó</button>
            </div>
            <div id="preview-img-container">
                <img id="preview-img" width="360" height="360" alt="Preview Image" src="image/dummy_preview.png">
            </div>
            <div>
                <select id="sending-mode-select">
                    <option value="lines">üñäÔ∏è Á∑öÁîª„Å®„Åó„Å¶Ëª¢ÈÄÅ / Send as Line Art</option>
                    <option value="rough">üñåÔ∏è „É©„Éï„Å®„Åó„Å¶Ëª¢ÈÄÅ / Send as Rough Sketch</option>
                </select>
                <br>
            <button id="launch-rakugaki_pao-button">‚ñ∂ rakugaki_pao </button>
            
            </div>
        </div>
    </div>

    </div>

    <script>
        //HTMLË¶ÅÁ¥†„ÅÆÂèñÂæó
        const clearButton = document.getElementById('clear');
        const manualButton = document.getElementById('manual');
        
        const copyButton = document.getElementById('copy-button');
        const saveButton = document.getElementById('save-button');
        const shareButton = document.getElementById('share-button');

        const canvasContainer = document.getElementById('canvas-container');
        const lineLayer = document.getElementById('line-layer');
        const colorLayer = document.getElementById('color-layer');
        const cursor = document.getElementById('cursor');
        const combinedCanvas = document.createElement('canvas');
        const invertCanvas = document.createElement('canvas');

        const openLaunchRakugaki_paoDialogButton = document.getElementById('open-launch-rakugaki_pao-dialog-button');

        const hashtagLine = document.getElementById('hashtag-line');
        const messageLine = document.getElementById('message-line');
        const copyHashtagButton = document.getElementById('copy-hashtag');

        const modals = document.getElementsByClassName('modal');
        const launchRakugaki_paoModal = document.getElementById('launch-rakugaki_pao-modal');
        const closePostDialogButton = document.getElementById('close-post-dialog-button');
        const previewImg = document.getElementById("preview-img");
        const sendingModeSelect = document.getElementById('sending-mode-select');
        const launchRakugaki_paoButton = document.getElementById('launch-rakugaki_pao-button');

        // „Éñ„É©„Ç¶„Ç∂„ÅÆË®ÄË™ûË®≠ÂÆöÊ§úÂá∫
        const browserLanguage = navigator.language.startsWith('ja') ? 'ja' : 'en';

        //ÈáçË¶Å„Å™Ë®≠ÂÆö
        const rakugaki_paoBlackPenColor = "#36364A";
        const rakugaki_paoRoughColor = "#B1E6DB";

        const boardColor = rakugaki_paoBlackPenColor
        const penColor1 = "#39C2D6";
        const penColor2 = "#3BEAC0";
        const [canvasWidth,canvasHeight] = [720,720];
        const smoothingFactor = 0.375;
        const hashtag = '#pao_board';
        const toolDiameter = 2; //ÊèèÁîª„ÉÑ„Éº„É´„ÅÆÁõ¥ÂæÑ(px)


        //„Ç≠„É£„É≥„Éê„Çπ„ÅÆÂàùÊúüÂåñ
        canvasContainer.style.width = canvasWidth + 'px';
        canvasContainer.style.height = canvasHeight + 'px';
        [combinedCanvas.width, combinedCanvas.height] = [canvasWidth, canvasHeight];
        [lineLayer.width, lineLayer.height] = [canvasWidth, canvasHeight];
        [colorLayer.width, colorLayer.height] = [canvasWidth, canvasHeight];
        [invertCanvas.width, invertCanvas.height] = [canvasWidth, canvasHeight];

        const ctxLine = lineLayer.getContext('2d',{ willReadFrequently: true });
        const ctxColor = colorLayer.getContext('2d',{ willReadFrequently: true });
        const ctxCombined = combinedCanvas.getContext('2d');
        const ctxInvert = invertCanvas.getContext('2d');


        //„Çπ„Éà„É¨„Éº„Ç∏„Ç≠„Éº
        const localstorageKeyPBLine = 'pblineLayerlskey';
        const localstoragekeyRakugaki_paoLine = 'pao_board2rakugaki_paoKey';
        const localstorageKeyFirstStrokeTime = 'FirstStrokeTimekey';

        const rakugaki_paoImportKeyBlack = 'importblacklayer';
        const rakugaki_paoImportKeyColor = 'importcolorlayer';
        let rakugaki_paoImportParamKey = rakugaki_paoImportKeyBlack;
         
        const manualUrl = "manual.html"
        const shareUrl = "https://kurajo.ivory.ne.jp/pao_board/"
        
        //Â§âÊï∞„ÅÆÂàùÊúüÂåñ
        let outputFileName = 'pao_board.png';
        let isDrawing = false;
        let [lastX,lastY] =[0,0];
        let [beforeLastX,beforeLastY] = [0,0];
        let isWaitingFirstStroke = window.localStorage.getItem(localstorageKeyFirstStrokeTime) == null;
        

        // „Éú„Çø„É≥È°û„ÅÆ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóË®≠ÂÆö
        const translations = {
            ja: {
                clear: "„Ç≠„É£„É≥„Éê„Çπ„ÅÆ„ÇØ„É™„Ç¢",
                copyButton: "„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº",
                saveButton: "„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶‰øùÂ≠ò",
                shareButton: "ÂÖ±Êúâ",
                manual: "pao_board„Å´„Å§„ÅÑ„Å¶",
                copyHashtagButton: "„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞„Çí„Ç≥„Éî„Éº",
                sendingModeSelect: "rakugaki_pao„Å∏„ÅÆÈÄÅ‰ø°„É¢„Éº„ÉâÈÅ∏Êäû",
                submitButton: "‚ñ∂ rakugaki_pao ",
                sendModeOptions: {
                    lines: "üñäÔ∏è Á∑öÁîª„Å®„Åó„Å¶Ëª¢ÈÄÅ„ÄÄ",
                    rough: "üñåÔ∏è „É©„Éï„Å®„Åó„Å¶Ëª¢ÈÄÅ„ÄÄ",
                },
                messages: {
                    canvasCleared: "„Ç≠„É£„É≥„Éê„Çπ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü",
                    noDrawing: "„Åæ„Å†„ÅäÁµµ„Åã„Åç„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ",
                    drawingSeconds: "{sec}Áßí „ÅäÁµµ„Åã„Åç„Åó„Åæ„Åó„Åü„ÄÇ",
                    drawingMinutes: "{min}ÂàÜ „ÅäÁµµ„Åã„Åç„Åó„Åæ„Åó„Åü„ÄÇ",
                    imageCopied: "ÁîªÂÉè„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü",
                    hashtagCopied: "„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü",
                }
            },
            en: {
                clear: "Clear Canvas",
                copyButton: "Copy to Clipboard",
                saveButton: "Save to Download",
                shareButton: "Share",
                manual: "About pao_board",
                copyHashtagButton: "Copy Hashtag",
                sendingModeSelect: "Select Sending Mode to rakugaki_pao",
                submitButton: "‚ñ∂ rakugaki_pao ",
                sendModeOptions: {
                    lines: "üñäÔ∏è Send as line drawing",
                    rough: "üñåÔ∏è Send as rough sketch"
                },
                messages: {
                    canvasCleared: "Canvas cleared",
                    noDrawing: "No drawing has been made yet.",
                    drawingSeconds: "Drew for {sec} seconds.",
                    drawingMinutes: "Drew for {min} minutes.",
                    imageCopied: "Image copied to clipboard",
                    hashtagCopied: "Hashtag copied to clipboard",
                }
            }
        };
        const currentTranslations = translations[browserLanguage];

        //„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆÁôªÈå≤
        clearButton.addEventListener('click', clearCanvas);
        manualButton.addEventListener('click', openManual);
        
        copyButton.addEventListener('click', copyImage);
        saveButton.addEventListener('click', saveImage);
        shareButton.addEventListener('click', shareImage);

        lineLayer.addEventListener('mousedown', startDrawingMouse);
        lineLayer.addEventListener('mousemove', drawMouse);
        lineLayer.addEventListener('mouseup', stopDrawing);
        lineLayer.addEventListener('mouseout', stopDrawingMouseOut);
        lineLayer.addEventListener('mousemove', updateCursorMouse);
        lineLayer.addEventListener('touchstart', startDrawingTouch);
        lineLayer.addEventListener('touchmove', drawTouch);
        lineLayer.addEventListener('touchend', stopDrawingTouch);
        lineLayer.addEventListener('touchcancel', stopDrawingTouch);
        lineLayer.addEventListener('touchmove', updateCursorTouch);

        openLaunchRakugaki_paoDialogButton.addEventListener('click', openLaunchRakugaki_paoDialog);
        sendingModeSelect.addEventListener('change', sendingModeSelectApplyAndGenInvertCanvas);
        launchRakugaki_paoButton.addEventListener('click', sendAndLaunchRakugaki_pao);
        closePostDialogButton.addEventListener('click',closeDialog);

        //„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„Ç≠„Éº„ÅÆÁôªÈå≤
        document.addEventListener('keydown', event => {
            const target = event.target;
            switch (event.code) {
                case 'KeyR':
                    reloadPage();
                    break;
                case 'KeyN':
                    clearCanvas();
                    break;
                case 'KeyT':
                    showElapsedTimeFromFirstStrokeTime();
                    break;
                case 'Escape':
                    closeDialog();
                    break;
                default:
                    return;
            }
        });

        //ÂàùÊúüÂåñ
        restoreLayerOnLocalstorage();
        if(null === window.localStorage.getItem(localstorageKeyFirstStrokeTime)){
            setFirstStrokeTime();
            initializeCanvasLayers();
        }
        initializeBackgroundLayer();
        initializeModal();
        setTooltips();
        setSendModeOptions();

        //Èñ¢Êï∞

        //ÊèèÁîª„Å´Èñ¢„Åô„ÇãÈñ¢Êï∞
        function startDrawing(x, y) {
            isDrawing = true;
            [lastX, lastY] = [x, y];
            [beforeLastX,beforeLastY] = [x,y]
            if (isWaitingFirstStroke){
                onFirstStrokeDetected();
            }
            stipple(x,y);
        }

        function draw(x, y) {
            if (!isDrawing) return;
            ctxLine.beginPath();
            ctxLine.moveTo(lastX, lastY);
            const travelSquared = (x-lastX)**2 + (y-lastY)**2;
            if(64 < travelSquared){
                const [xM,yM] = [lastX + (x - beforeLastX)/4, lastY + (y - beforeLastY)/4]; 
                ctxLine.lineTo(xM, yM); //ÁßªÂãïÈáè„ÅåÂ§ö„ÅÑ„Å®„Åç„ÄÅË£úÈñìÁÇπ„Çí‰Ωú„Å£„Å¶ÁµåÁî±„Åó„Åæ„Åô
                [lastX,lastY] = [xM,yM];
            }else{
                x = x*(1-smoothingFactor) + lastX*smoothingFactor;
                y = y*(1-smoothingFactor) + lastY*smoothingFactor;
            }
            ctxLine.lineTo(x, y);
            ctxLine.globalCompositeOperation = 'destination-out';
            ctxLine.lineWidth = toolDiameter;
            ctxLine.lineCap = 'round';
            ctxLine.stroke();
            
            [beforeLastX,beforeLastY] = [lastX,lastY];
            [lastX, lastY] = [x, y];
        }

        function stipple(x,y){
            ctxLine.beginPath();
            ctxLine.moveTo(x, y);
            ctxLine.globalCompositeOperation = 'destination-out';
            ctxLine.arc(x,y, toolDiameter*0.5, 0, 2*Math.PI, true);
            ctxLine.closePath();
            ctxLine.fill();
        }

        function stopDrawing() {
            isDrawing = false;
            saveLocalstorage();
        }

        function stopDrawingMouseOut(){
            stopDrawing();
            setCursorInvisible();
        }

        function updateCursor(x, y) {            
            setCursorVisible();
            cursor.style.width = `${toolDiameter}px`;
            cursor.style.height = `${toolDiameter}px`;
            cursor.style.left = `${x - toolDiameter * 0.5}px`;
            cursor.style.top = `${y - toolDiameter * 0.5}px`;
        }

        function startDrawingMouse(e) {
            startDrawing(e.offsetX, e.offsetY);
        }

        function drawMouse(e) {
            draw(e.offsetX, e.offsetY);
        }
            
        function updateCursorMouse(e) {
            updateCursor(e.offsetX, e.offsetY);
        }

        function touchToOffsetXY(e) {
            const target = e.touches[0].target;
            const r = target.getBoundingClientRect();
            return [e.touches[0].clientX - r.left, e.touches[0].clientY - r.top];
        }

        function startDrawingTouch(e) {
            e.preventDefault();
            startDrawing(...touchToOffsetXY(e));
        }

        function drawTouch(e) {
            e.preventDefault();
            draw(...touchToOffsetXY(e));
        }
        
        function stopDrawingTouch() {
            stopDrawing();
            setCursorInvisible();
        }
            
        function updateCursorTouch(e) {
            e.preventDefault();
            updateCursor(...touchToOffsetXY(e));
        }
        
        //Ë£Ω‰Ωú‰∏≠„ÅÆÁµµ„ÅÆ‰øùÂ≠ò„ÉªË™≠Ëæº„Å´Èñ¢„Åô„ÇãÈñ¢Êï∞
        function saveLocalstorage() {
            saveLayeronlocalstorage(localstorageKeyPBLine,lineLayer);    
        }
        
        function saveLayeronlocalstorage(localstoragekey,layer){
            window.localStorage.setItem(localstoragekey,layer.toDataURL());
        }

        function loadImageFromDataURL(dataURL) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = (e) => reject(e);
                img.src = dataURL;
            });
        }     

        async function restoreLayerOnLocalstorage() {
            // „É¨„Ç§„É§„ÉºÁîªÂÉè„ÅÆÂæ©ÂÖÉ
            const restoreLayerAsync = async (localstorageKey, layer) => {
                const dataURL = window.localStorage.getItem(localstorageKey);
                if (dataURL == null) return;

                try {
                    const img = await loadImageFromDataURL(dataURL);
                    const ctx = layer.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                } catch (e) {
                    console.error(`Failed to restore layer for ${localstorageKey}`, e);
                }
            };

            try {
                await Promise.all([
                    restoreLayerAsync(localstorageKeyPBLine, lineLayer),
                ]);
                if (isCanvasEmpty()) {  // „É¨„Ç§„É§„ÉºÂæ©ÂÖÉÂæå„Å´„Ç≠„É£„É≥„Éê„Çπ„ÅåÁ©∫„Åã„Å©„ÅÜ„ÅãÂà§ÂÆö
                    resetFirstStrokeState();
                }
            } catch (e) {
                console.error('Layer restoration failed', e);
            }
        }


        
        function initializeCanvasLayers(){
            ctxLine.globalCompositeOperation = 'source-over';
            ctxLine.fillStyle = boardColor;
            ctxLine.fillRect(0,0, canvasWidth,canvasHeight);
        }

        function initializeBackgroundLayer(){
            ctxColor.globalCompositeOperation = 'source-over';
            const gradient = ctxColor.createLinearGradient(0, 0, canvasWidth/5, canvasHeight);
            gradient.addColorStop(0, penColor1); 
            gradient.addColorStop(1, penColor2);
            ctxColor.fillStyle = gradient;
            ctxColor.fillRect(0, 0, canvasWidth, canvasHeight);
        }
        
        //„É™„É≠„Éº„Éâ„ÉªURL„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Å´Èñ¢„Åô„ÇãÈñ¢Êï∞
        function reloadPage(){
            saveLocalstorage();
            location.reload()
        }


        //„Ç≠„É£„É≥„Éê„Çπ„ÇØ„É™„Ç¢„ÉªÁµåÈÅéÊôÇÈñìË°®Á§∫„Å´Èñ¢„Åô„ÇãÈñ¢Êï∞
        function clearCanvas() {
            initializeCanvasLayers();
            saveLocalstorage();
            resetFirstStrokeState()
            showMessage(currentTranslations.messages.canvasCleared);
        }

        function setFirstStrokeTime(){
            const nowTime = new Date();
            const firstStrokeTime = nowTime.getTime();
            window.localStorage.setItem(localstorageKeyFirstStrokeTime, firstStrokeTime);
        }

        function getElapsedTimeMinFromFirstStrokeTime(){
            const firstStrokeTime = window.localStorage.getItem(localstorageKeyFirstStrokeTime) || null
            const nowTime = new Date();
            const elapsedTimeMin = Math.trunc((nowTime.getTime() - firstStrokeTime)/1000/60);
            return elapsedTimeMin;
        }

        function getElapsedTimeSecFromFirstStrokeTime(){
            const firstStrokeTime = window.localStorage.getItem(localstorageKeyFirstStrokeTime) || null
            const nowTime = new Date();
            const elapsedTimeSec = Math.trunc((nowTime.getTime() - firstStrokeTime)/1000);
            return elapsedTimeSec;
        }
        
        function showElapsedTimeFromFirstStrokeTime(){
            const elapsedTimeMin = getElapsedTimeMinFromFirstStrokeTime();
            const sec = getElapsedTimeSecFromFirstStrokeTime() - elapsedTimeMin * 60;
            if( isWaitingFirstStroke ){
                showMessage(currentTranslations.messages.noDrawing);
            }else if( elapsedTimeMin < 1) {
                showMessage(currentTranslations.messages.drawingSeconds.replace('{sec}', sec));
            }else{
                showMessage(currentTranslations.messages.drawingMinutes.replace('{min}', elapsedTimeMin));
            }
        }

        //„Éû„Éã„É•„Ç¢„É´Ë°®Á§∫
        function openManual(){
            location.href = manualUrl;
        }

        function isCanvasEmpty(){
            const lineData = ctxLine.getImageData(0,0,canvasWidth, canvasHeight).data;
            for(let i=0; i<lineData.length; i++){
                if( lineData[i] !== 0 ){
                    return false;
                }
            }
            return true;
        }

        function onFirstStrokeDetected(){
            setFirstStrokeTime();
            isWaitingFirstStroke = false;
        }

        function resetFirstStrokeState(){
            window.localStorage.removeItem(localstorageKeyFirstStrokeTime);
            isWaitingFirstStroke = true;
        }

        // „Éú„Çø„É≥„ÅÆ„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Éª„É©„Éô„É´„ÇíË®≠ÂÆö
        function setTooltips() {
            clearButton.title = currentTranslations.clear;
            copyButton.title = currentTranslations.copyButton;
            saveButton.title = currentTranslations.saveButton;
            shareButton.title = currentTranslations.shareButton;
            manualButton.title = currentTranslations.manual;
            copyHashtagButton.title = currentTranslations.copyHashtagButton;
            sendingModeSelect.title = currentTranslations.sendingModeSelect;
            launchRakugaki_paoButton.textContent = currentTranslations.submitButton;
        }

        // sending-mode-select„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
        function setSendModeOptions() {
            const options = sendingModeSelect.querySelectorAll('option');
            options[0].textContent = currentTranslations.sendModeOptions.lines;
            options[1].textContent = currentTranslations.sendModeOptions.rough;
        }

        //„Ç´„Éº„ÇΩ„É´Ë°®Á§∫„Å´Èñ¢„Åô„ÇãÈñ¢Êï∞
        function setCursorVisible(){
            cursor.style.borderWidth = '2px';
        }

        function setCursorInvisible(){
            cursor.style.borderWidth = '0px';
        }

        //Áµµ„ÅÆ‰øùÂ≠ò„Å´Èñ¢„Åô„ÇãÈñ¢Êï∞
        function combineCanvas() {
            ctxCombined.drawImage(colorLayer, 0, 0);
            ctxCombined.drawImage(lineLayer, 0, 0);
        }

        function dataURLToBlob(dataURL) {
            const parts = dataURL.split(';base64,');
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const rawLength = raw.length;
            const uInt8Array = new Uint8Array(rawLength);
            for (let i = 0; i < rawLength; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }
            return new Blob([uInt8Array], { type: contentType });
        }

        function setOutputFileName(){
            const nowTime = new Date();
            const timeString = nowTime.toLocaleString("ja-JP", {year: "numeric",month: "2-digit", day: "2-digit", hour:"2-digit", minute:"2-digit"}).replaceAll('/', '').replaceAll(':','').replaceAll(' ','-');
            outputFileName = timeString + '_pao_board(' + getElapsedTimeMinFromFirstStrokeTime() +'min).png';
        }

        function copyImage() {
            combineCanvas();
            combinedCanvas.toBlob(async (blob) => {
                const item = new ClipboardItem({'image/png': blob});
                await navigator.clipboard.write([item]);
            })
            showMessage(currentTranslations.messages.imageCopied);
            showElapsedTimeFromFirstStrokeTime();
        }

        function saveImage() {
            combineCanvas();    
            setOutputFileName();        
            const dataURL = combinedCanvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = outputFileName;
            link.href = dataURL;
            link.click();
            showElapsedTimeFromFirstStrokeTime();
        }

        function shareImage() {
            combineCanvas();
            setOutputFileName();           
            const dataURL = combinedCanvas.toDataURL('image/png');
            const blob = dataURLToBlob(dataURL);
            const imageFile = new File([blob], outputFileName, {type: "image/png",});
            navigator.share({
                url: shareUrl,
                text: hashtag,
                title: 'pao_board',
                files: [imageFile],
            }).then(() => {
                console.log("ÂÖ±Êúâ„Åó„Åæ„Åó„Åü„ÅÆ / Shared successfully");
            }).catch((error) => {
                console.log('ÂÖ±Êúâ„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÅÆ‚Ä•‚Ä• / Failed to share');
            });
            showElapsedTimeFromFirstStrokeTime();
        }
               
        //„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞„ÅÆ„Ç≥„Éî„Éº„Å´Èñ¢„Åô„ÇãÈñ¢Êï∞
        function copyHastag() {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(hashtag).then(function () {
                    showMessage(currentTranslations.messages.hashtagCopied);
                }).catch(function (error) {
                    alert('„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞„ÅÆ„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÅÆ / Failed to copy hashtag');
                });
            } else {
                alert('„ÉÜ„Ç≠„Çπ„Éà„Çí„Ç≥„Éî„Éº„Åß„Åç„Åæ„Åõ„Çì„ÅÆ / Cannot copy text');
            }
        }
        
        //‰∏ãÈÉ®ÊÉÖÂ†±Ë°®Á§∫„Å´Èñ¢„Åô„ÇãÈñ¢Êï∞
        function showMessage(text) {
            showMessage.queue = showMessage.queue || [];
            showMessage.queue.push(text);
            
            async function processQueue() {
                while (showMessage.queue.length > 0) {
                    const message = showMessage.queue.shift();
                    await new Promise((resolve) => {   
                        messageLine.style.display = 'flex';
                        hashtagLine.style.display = 'none';
                        messageLine.textContent = message; 
                        
                        setTimeout(() => {
                            messageLine.style.display = 'none';
                            hashtagLine.style.display = 'flex';
                            resolve();
                        }, 1800);
                    });
                }
            }
            if (!showMessage.isProcessing) {
                showMessage.isProcessing = true;
                processQueue().then(() => {
                    showMessage.isProcessing = false;
                });
            }
        }

        //„Éè„ÉÉ„Ç∑„É•„Çø„Ç∞„Ç≥„Éî„Éº„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÁôªÈå≤
        copyHashtagButton.addEventListener('click', copyHastag);    

        
        //„ÉÄ„Ç§„Ç¢„É≠„Ç∞ÂÖ±ÈÄö
        function closeDialog() {
            for (let i = 0; i < modals.length; i++) {
                modals[i].style.display = 'none'; 
            }
        }

        function initializeModal(){
            for (let i = 0; i < modals.length; i++) {
                //modals[i].style.display = 'none'; // ÂêÑË¶ÅÁ¥†„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
                modals[i].addEventListener('click', (event) => {
                    if (event.target === modals[i]) {
                        closeDialog();
                    }
                });
            }
        }

        //rakugaki_paoËª¢ÈÄÅ„Å´Èñ¢ÈÄ£„Åô„ÇãÈñ¢Êï∞
        //ÊäïÁ®ø„ÉÄ„Ç§„Ç¢„É≠„Ç∞
        function openLaunchRakugaki_paoDialog() {
            showElapsedTimeFromFirstStrokeTime();
            sendingModeSelectApplyAndGenInvertCanvas();
            launchRakugaki_paoModal.style.display = 'block';
        }

        function sendingModeSelectApplyAndGenInvertCanvas(){
            const selectedMode = sendingModeSelect.value;
            if(selectedMode === 'lines'){
                invertCtxLineAlphaAndChangeColor(rakugaki_paoBlackPenColor); 
                rakugaki_paoImportParamKey = rakugaki_paoImportKeyBlack;
            }else if(selectedMode === 'rough'){
                invertCtxLineAlphaAndChangeColor(rakugaki_paoRoughColor);  
                rakugaki_paoImportParamKey = rakugaki_paoImportKeyColor;
            }
            const dataURL = invertCanvas.toDataURL('image/png');
            previewImg.src = dataURL;
        }

        function invertCtxLineAlphaAndChangeColor(targetColorCode = "#FF0000"){ 
            const hex = targetColorCode.replace('#', '');
            const targetR = parseInt(hex.substring(0, 2), 16);
            const targetG = parseInt(hex.substring(2, 4), 16);
            const targetB = parseInt(hex.substring(4, 6), 16);
            // lineLayer„ÅÆ„Éî„ÇØ„Çª„É´„Éá„Éº„Çø„ÇíÂèñÂæó
            const imageData = ctxLine.getImageData(0, 0, canvasWidth, canvasHeight);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                data[i + 0] = targetR;
                data[i + 1] = targetG;
                data[i + 2] = targetB;      
                const currentAlpha = data[i + 3];
                data[i + 3] = 255 - currentAlpha;
            }
            ctxInvert.putImageData(imageData, 0, 0);
        }

        function saveInvertCanvasLocalstorage(){
            saveLayeronlocalstorage(localstoragekeyRakugaki_paoLine,invertCanvas);    
        }

        function sendAndLaunchRakugaki_pao(){
            saveInvertCanvasLocalstorage();
            window.open('../rakugaki_pao/index.html?' + rakugaki_paoImportParamKey + '=' + localstoragekeyRakugaki_paoLine);
            closeDialog();
        }
    </script>
</body>
</html>
